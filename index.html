<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üçÅ Haliport ‚Äî Private 1:1 Chat</title>
<style>
  :root{ --bg:#0b0f14; --panel:#121923; --panel2:#0f151e; --text:#e9f0f7; --muted:#9fb0c2; --accent:#57acff; --border:#1f2b3b; --glass:rgba(255,255,255,.06); --danger:#ff6b6b; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  .header{height:64px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--panel)}
  .scroll{flex:1;overflow:auto;padding:18px}
  .row{display:flex;margin:10px 0;position:relative}
  .me{justify-content:flex-end}
  .bubble{max-width:900px;width:fit-content;background:#172131;border:1px solid var(--border);padding:12px 14px;border-radius:16px;font-size:1.05rem;line-height:1.5;position:relative}
  .me .bubble{background:#0f2744;border-color:#133659}
  .meta{color:#9fb0c2;font-size:.85rem;margin-top:6px;text-align:right}
  .composer{position:sticky;bottom:0;display:flex;gap:12px;align-items:flex-end;border-top:1px solid var(--border);padding:14px 16px;background:var(--panel)}
  .textarea{flex:1;min-height:56px;max-height:220px;padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--panel2);color:var(--text);resize:vertical;font-size:1.05rem;line-height:1.5;outline:none}
  .send{background:#1b87f3;border:0;color:#fff;padding:14px 22px;border-radius:14px;cursor:pointer;font-size:1rem}
  .iconbtn{border:1px solid var(--border);background:var(--panel2);color:var(--text);border-radius:12px;cursor:pointer;height:48px;width:48px;display:grid;place-items:center}
  .filecard{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .filename{word-break:break-all}
  .btn-min{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--glass);cursor:pointer;color:#e7edf4;text-decoration:none}
  .btn-min:hover{background:rgba(255,255,255,.12)}
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; font-size:.78rem; background:#10263e; color:#b8d5ff; border:1px solid #1c3a5e }
  .tomb { font-style:italic; color:#d2dcea }
  .expiry{ color:var(--danger); font-size:.85rem; margin-top:6px }
  .sys{ color:#b7c6d8; font-size:.86rem; margin-top:6px; }
  .row.me .sys{ text-align:right; }
  .status{ color:#9fb0c2; font-size:.92rem; }

  .kebab{ position:absolute; top:6px; right:6px; width:32px; height:32px; display:grid; place-items:center; font-size:18px; background:var(--glass); border:1px solid rgba(255,255,255,.18); border-radius:10px; color:#e7edf4; cursor:pointer; opacity:.7; }
  .bubble:hover .kebab{ opacity:1; }
  .menu{ position:absolute; top:42px; right:6px; background:#0e1622; border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.4); display:none; min-width:170px; z-index:5; }
  .menu.open{ display:block }
  .menu button{ width:100%; text-align:left; padding:10px 12px; background:transparent; border:0; color:#e7edf4; cursor:pointer; font-size:.95rem }

  .viewer-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:60; }
  .viewer-overlay.open{ display:block; }
  .viewer{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(1200px, 96vw); height:min(80vh, 900px); background:#0e1520; border:1px solid var(--border); border-radius:16px; box-shadow:0 30px 120px rgba(0,0,0,.7); display:none; z-index:61; overflow:hidden; }
  .viewer.open{ display:flex; flex-direction:column; }
  .viewer-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border); background:#101827 }
  .viewer-title{ font-weight:600; color:#dfeafb; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .viewer-close{ border:1px solid var(--border); background:var(--glass); color:#e7edf4; padding:6px 10px; border-radius:10px; cursor:pointer }
  .viewer-body{ flex:1; background:#0b111b }
  .viewer-body iframe, .viewer-body embed, .viewer-body img{ width:100%; height:100%; border:0; display:block; }
  .viewer-fallback{ color:#cfe1f7; padding:20px; }

  /* Upload Options modal */
  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:70; }
  .modal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(560px, 96vw); background:#0f151e; color:#e9f0f7; border:1px solid var(--border); border-radius:16px; box-shadow:0 30px 120px rgba(0,0,0,.7); display:none; z-index:71; }
  .modal.open{ display:block; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); font-weight:600; }
  .modal-body{ padding:14px 16px; display:grid; gap:12px; }
  .modal-grid{ display:grid; gap:10px; grid-template-columns: repeat(4, 1fr); }
  .modal-footer{ display:flex; gap:10px; justify-content:flex-end; padding:14px 16px; border-top:1px solid var(--border); }
  .input{ width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#101725; color:#e9f0f7; }
  .checkrow{ display:flex; align-items:center; gap:10px; }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div><b id="title">Connecting‚Ä¶</b></div>
    <div id="presence" class="status">‚Äî</div>
  </div>

  <div class="scroll" id="log"><div class="status">Open this URL on two devices to start chatting.</div></div>
  <p class="status" style="margin:0 18px 8px">Enter to send ‚Ä¢ Shift+Enter newline ‚Ä¢ Paperclip to attach ‚Ä¢ ‚ãØ to recall ‚Ä¢ üëÅÔ∏è to view inline</p>

  <div class="composer">
    <button id="attach" class="iconbtn" title="Attach files" aria-label="Attach files">üìé</button>
    <input id="fileInput" type="file" multiple hidden />
    <textarea id="msg" class="textarea" placeholder="Type a message"></textarea>
    <button id="send" class="send">Send</button>
  </div>
</div>

<!-- Viewer -->
<div id="viewerOverlay" class="viewer-overlay"></div>
<div id="viewer" class="viewer" role="dialog" aria-modal="true" aria-labelledby="viewerTitle">
  <div class="viewer-header">
    <div id="viewerTitle" class="viewer-title">Preview</div>
    <button id="viewerClose" class="viewer-close">Close</button>
  </div>
  <div id="viewerBody" class="viewer-body"></div>
</div>

<!-- Upload Options Modal -->
<div id="upModalOverlay" class="modal-overlay"></div>
<div id="upModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="upTitle">
  <div class="modal-header">
    <div id="upTitle">Upload Options</div>
    <button id="upClose" class="btn-min">‚úï</button>
  </div>
  <div class="modal-body">
    <div>
      <div style="margin-bottom:6px;color:#b7c6d8">Recall after (DD/MM/HH/MM)</div>
      <div class="modal-grid">
        <input id="recDays" class="input" type="number" min="0" placeholder="Days" />
        <input id="recMonths" class="input" type="number" min="0" placeholder="Months" />
        <input id="recHours" class="input" type="number" min="0" placeholder="Hours" />
        <input id="recMinutes" class="input" type="number" min="0" placeholder="Minutes" />
      </div>
      <div class="status" style="margin-top:6px">Tip: leave all 0 for no auto-recall.</div>
    </div>

    <div>
      <div style="margin-bottom:6px;color:#b7c6d8">Password (optional ‚Äî incorrect password will recall the file)</div>
      <input id="upPassword" class="input" type="password" placeholder="Password (optional)" />
    </div>

    <div class="checkrow">
      <input id="allowDownload" type="checkbox" checked />
      <label for="allowDownload">Allow download</label>
    </div>
    <div class="status">If unchecked, file is <b>view-only</b> (inline preview, no direct download).</div>
  </div>
  <div class="modal-footer">
    <button id="upCancel" class="btn-min">Cancel</button>
    <button id="upConfirm" class="btn-min">Upload</button>
  </div>
</div>

<script>
const log = document.getElementById('log');
const title = document.getElementById('title');
const presence = document.getElementById('presence');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const attachBtn = document.getElementById('attach');
const fileInput = document.getElementById('fileInput');

let myId = null;
let myRoom = location.pathname.replace(/^\/+|\/+$/g,'') || 'chat';
let pendingFiles = [];

// WS URL helper
function wsURL(){
  const proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
  return proto + location.host + location.pathname;
}
function esc(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function humanSize(b){ const u=['B','KB','MB','GB']; let v=b,i=0; while(v>=1024&&i<u.length-1){v/=1024;i++;} return v.toFixed(v>=10||i===0?0:1)+' '+u[i]; }
function bubbleMenu(id, mine){ return `<button class="kebab" data-action="open-menu" data-id="${id}" ${mine?'':'style="display:none"'}>‚ãØ</button><div class="menu" data-menu-for="${id}"><button data-action="recall" data-id="${id}">Recall</button></div>`; }

function writeText(kind, id, text, ts=Date.now()){
  const row = document.createElement('div');
  row.className = 'row ' + (kind==='me' ? 'me' : '');
  row.dataset.id = id;
  row.innerHTML = `<div class="bubble">${bubbleMenu(id, kind==='me')}<div>${esc(text)}</div><div class="meta">${new Date(ts).toLocaleString()}</div></div>`;
  log.appendChild(row); log.scrollTop = log.scrollHeight;
}

function fileControlsHTML(id, file, hasUrl, isProtected, viewOnly){
  const viewBtn = hasUrl ? `<button class="btn-min view-btn" data-id="${id}" data-name="${esc(file.name)}" data-mime="${file.mime || ''}" title="View in app">üëÅÔ∏è View</button>` : '';
  const showDownload = hasUrl && !isProtected && !viewOnly;
  const download = showDownload ? `<a class="btn-min" href="${file.url}" download title="Download">‚¨áÔ∏è Download</a>` : '';
  return `<div class="file-commands" style="display:flex; gap:8px">${viewBtn}${download}</div>`;
}

function writeFile(kind, id, file, ts=Date.now(), expiresAt=null){
  const row = document.createElement('div'); row.className = 'row ' + (kind==='me' ? 'me' : ''); row.dataset.id = id;
  const line = `<span class="filename">${esc(file.name)}</span> <span style="color:#9fb0c2">(${humanSize(file.size)})</span>`;
  const badges = [
    file.protected ? `<span class="badge">üîí Password</span>` : '',
    file.viewOnly ? `<span class="badge">üëÅÔ∏è View-only</span>` : ''
  ].join(' ');
  const commands = fileControlsHTML(id, file, !!file.url, !!file.protected, !!file.viewOnly);
  row.innerHTML = `<div class="bubble">${bubbleMenu(id, kind==='me')}<div class="filecard">${line}${badges}</div>${commands}${expiresAt ? `<div class="expiry" data-expires="${expiresAt}" data-id="${id}">‚è± calculating‚Ä¶</div>` : ''}<div class="meta">${new Date(ts).toLocaleString()}</div></div>`;
  log.appendChild(row);

  // If protected & receiver: show unlock field
  if (file.protected && !file.url && kind !== 'me') {
    const bubble = row.querySelector('.bubble');
    const wrap = document.createElement('div');
    wrap.style.marginTop = '10px';
    wrap.innerHTML = `<input type="password" class="pwfield" placeholder="Enter password to unlock" style="background:#101725;color:#e7edf4;border:1px solid var(--border);border-radius:10px;padding:10px;width:240px"><button class="btnUnlock btn-min" data-id="${id}">Unlock</button>`;
    bubble.appendChild(wrap);
  }
  log.scrollTop = log.scrollHeight;
}

function recallForReceiver(id, sysText){
  const row = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`); if (!row) return;
  const bubble = row.querySelector('.bubble'); if (bubble) bubble.innerHTML = `<div class="tomb">This item was recalled by the sender.</div>`;
  const sys = document.createElement('div'); sys.className='sys'; sys.textContent = sysText || 'This item was recalled by the sender.'; bubble?.appendChild(sys);
}
function markOwnerRecalled(id, sysText){
  const row = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`); if (!row) return;
  const sys = document.createElement('div'); sys.className='sys'; sys.textContent = sysText || 'You recalled this. The other person can no longer see it.'; row.querySelector('.bubble')?.appendChild(sys);
  row.querySelector('.expiry')?.remove();
}
function setOwnerUrl(id){
  const row = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`);
  if (!row) return;
  const commands = row.querySelector('.file-commands');
  if (commands && !commands.querySelector('.view-btn')) {
    const name = row.querySelector('.filename')?.textContent || 'file';
    const btn = document.createElement('button');
    btn.className = 'btn-min view-btn';
    btn.dataset.id = id; btn.dataset.name = name;
    btn.textContent = 'üëÅÔ∏è View';
    commands.prepend(btn);
  }
}

function fmtRemaining(ms){ if (ms<=0) return 'recalling‚Ä¶'; const s=Math.floor(ms/1000); const d=Math.floor(s/86400); const h=Math.floor((s%86400)/3600); const m=Math.floor((s%3600)/60); const ss=s%60; const p=[]; if(d)p.push(d+'d'); if(h||d)p.push(h+'h'); if(m||h||d)p.push(m+'m'); p.push(ss+'s'); return '‚è± '+p.join(' '); }
setInterval(()=>{ const n=Date.now(); document.querySelectorAll('.expiry').forEach(el=>{ const exp=parseInt(el.getAttribute('data-expires')||'0',10); el.textContent = fmtRemaining(exp-n); }); },1000);

// ===== WS with retry =====
let ws, retries=0;
function connectWS(){
  const url = wsURL();
  presence.textContent = `Connecting to ${url}‚Ä¶`;
  ws = new WebSocket(url);

  ws.onopen = () => { retries=0; presence.textContent = 'Connected'; title.textContent = 'Room: '+myRoom; };

  ws.onerror = (e) => {
    console.error('[WS] error', e);
    presence.textContent = 'Connection error';
  };

  ws.onclose = (ev) => {
    console.warn('[WS] closed', ev.code, ev.reason);
    presence.textContent = 'Disconnected ‚Äî retrying‚Ä¶';
    const backoff = Math.min(3000 * (retries+1), 10000);
    retries++;
    setTimeout(connectWS, backoff);
  };

  ws.onmessage = (ev) => {
    const d = JSON.parse(ev.data);

    if (d.type === 'room_full') {
      presence.textContent = 'Room is full';
      writeText('them','_','Room is full. Create a new path, e.g., /chat-1234');
      return;
    }
    if (d.type === 'welcome') {
      myId = d.yourId;
      presence.textContent = `Connected ‚Ä¢ users: ${(d.users||[]).length}`;
      title.textContent = `Room: ${d.room} ‚Ä¢ You: ${myId}`;
      return;
    }
    if (d.type === 'presence') {
      presence.textContent = `Connected ‚Ä¢ users: ${(d.users||[]).length}`;
      return;
    }
    if (d.type === 'chat') {
      const who = d.fromId === myId ? 'me' : 'them';
      writeText(who, d.id, d.text, d.ts); return;
    }
    if (d.type === 'file') {
      const who = d.fromId === myId ? 'me' : 'them';
      writeFile(who, d.id, d.file, d.ts, d.expiresAt || null); return;
    }
    if (d.type === 'file_owner') { setOwnerUrl(d.id); return; }
    if (d.type === 'file_unlocked') {
      const row = log.querySelector(`.row[data-id="${CSS.escape(d.id)}"]`);
      row?.querySelector('.pwfield')?.remove();
      row?.querySelector('.btnUnlock')?.remove();
      setOwnerUrl(d.id);
      return;
    }
    if (d.type === 'recalled') { recallForReceiver(d.id, d.sys); return; }
    if (d.type === 'recalled_owner') { markOwnerRecalled(d.id, d.sys); return; }
    if (d.type === 'error') { writeText('them','_','‚ö†Ô∏è '+(d.message||'Error')); return; }
  };
}
connectWS();

// send / recall
function send(){ const text = msgInput.value.trim(); if(!text || ws.readyState!==1) return; ws.send(JSON.stringify({type:'chat', text})); msgInput.value=''; }
function recall(id){ if (ws.readyState!==1) return; ws.send(JSON.stringify({ type:'recall', id })); }
sendBtn.onclick = send;
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

// ===== Upload flow =====
async function uploadFiles(files, ttlSeconds=0, password='', allowDownload=true){
  const form = new FormData();
  for (const f of files) form.append('file', f);
  if (ttlSeconds>0) form.append('ttl', String(ttlSeconds));
  if (password) form.append('pw', password);
  // noDownload = true when allowDownload is false
  form.append('noDownload', allowDownload ? 'false' : 'true');
  if (myId) form.append('clientId', myId);
  const res = await fetch(`/upload/${encodeURIComponent(myRoom)}`, { method:'POST', body: form });
  if (!res.ok) {
    let j={}; try{ j=await res.json(); }catch{}
    writeText('them','_','‚ö†Ô∏è '+(j.error || ('Upload failed: '+res.status)));
  }
}

// Attach ‚Üí open modal after file pick
attachBtn.addEventListener('click', ()=> fileInput.click());

fileInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;
  pendingFiles = files;
  // Open modal for options
  openUpModal();
});

// ===== Modal logic =====
const upModal = document.getElementById('upModal');
const upOverlay = document.getElementById('upModalOverlay');
const upClose = document.getElementById('upClose');
const upCancel = document.getElementById('upCancel');
const upConfirm = document.getElementById('upConfirm');

const recDays = document.getElementById('recDays');
const recMonths = document.getElementById('recMonths');
const recHours = document.getElementById('recHours');
const recMinutes = document.getElementById('recMinutes');
const upPassword = document.getElementById('upPassword');
const allowDownload = document.getElementById('allowDownload');

function openUpModal(){ upOverlay.style.display='block'; upModal.classList.add('open'); }
function closeUpModal(){ upOverlay.style.display='none'; upModal.classList.remove('open'); }

upOverlay.addEventListener('click', closeUpModal);
upClose.addEventListener('click', closeUpModal);
upCancel.addEventListener('click', ()=>{ closeUpModal(); fileInput.value=''; pendingFiles = []; });

upConfirm.addEventListener('click', async () => {
  // Compute TTL from DD/MM/HH/MM (Months ~ 30 days)
  const d = parseInt(recDays.value||'0',10) || 0;
  const mo = parseInt(recMonths.value||'0',10) || 0;
  const h = parseInt(recHours.value||'0',10) || 0;
  const m = parseInt(recMinutes.value||'0',10) || 0;
  let ttlSec = (d + (mo*30)) * 24*3600 + h*3600 + m*60;
  if (ttlSec < 0) ttlSec = 0;

  const pwd = (upPassword.value||'').trim();
  const allow = !!allowDownload.checked;

  await uploadFiles(pendingFiles, ttlSec, pwd, allow);

  // reset
  closeUpModal();
  recDays.value = recMonths.value = recHours.value = recMinutes.value = '';
  upPassword.value = '';
  allowDownload.checked = true;
  fileInput.value = '';
  pendingFiles = [];
});

// ===== Unlock flow =====
log.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btnUnlock'); if (!btn) return;
  const id = btn.dataset.id;
  const row = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`);
  const pwf = row?.querySelector('.pwfield'); const pass = pwf?.value || '';
  try{
    const res = await fetch(`/unlock/${encodeURIComponent(id)}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pass }) });
    if (!res.ok) { const j = await res.json().catch(()=>({})); console.warn(j.error || 'Unlock failed'); }
  }catch(err){ console.warn(err); }
});

// ===== Menus =====
log.addEventListener('click', (e) => {
  const btn = e.target.closest('button'); if (!btn) return;
  const action = btn.dataset.action; const id = btn.dataset.id;
  if (action === 'open-menu') {
    document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
    const menu = log.querySelector(`.menu[data-menu-for="${CSS.escape(id)}"]`);
    if (menu) menu.classList.add('open');
  }
  if (action === 'recall') {
    const menu = log.querySelector(`.menu[data-menu-for="${CSS.escape(id)}"]`); if (menu) menu.classList.remove('open');
    recall(id);
  }
});
document.addEventListener('click', (e) => {
  const inside = e.target.closest('.menu, .kebab, .viewer'); if (!inside) document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
});

// ===== Viewer =====
const viewerOverlay = document.getElementById('viewerOverlay');
const viewer        = document.getElementById('viewer');
const viewerBody    = document.getElementById('viewerBody');
const viewerTitle   = document.getElementById('viewerTitle');
const viewerClose   = document.getElementById('viewerClose');
function openViewer(){ viewerOverlay.classList.add('open'); viewer.classList.add('open'); }
function closeViewer(){ viewerOverlay.classList.remove('open'); viewer.classList.remove('open'); viewerBody.innerHTML=''; viewerTitle.textContent='Preview'; }
viewerOverlay.addEventListener('click', closeViewer);
viewerClose.addEventListener('click', closeViewer);

log.addEventListener('click', async (e) => {
  const vb = e.target.closest('.view-btn'); if (!vb) return;
  const id = vb.dataset.id;
  let info;
  try{
    const res = await fetch(`/fileurl/${encodeURIComponent(id)}`);
    info = await res.json();
    if (!res.ok || !info?.ok) throw new Error(info?.error || 'Not accessible');
  }catch(err){
    writeText('them','_','‚ö†Ô∏è '+(err?.message || 'Preview not accessible'));
    return;
  }
  const { url, mime, name } = info;
  viewerTitle.textContent = name || 'Preview';
  viewerBody.innerHTML = '';

  if (/^image\//i.test(mime)) {
    const img = document.createElement('img'); img.src = url; img.alt = name || 'image'; viewerBody.appendChild(img);
  } else if (/^application\/pdf$/i.test(mime)) {
    const embed = document.createElement('embed'); embed.type = 'application/pdf'; embed.src = url + '#toolbar=1&navpanes=0&statusbar=0'; viewerBody.appendChild(embed);
  } else if (/^text\//i.test(mime)) {
    const iframe = document.createElement('iframe'); iframe.src = url; iframe.setAttribute('sandbox','allow-scripts allow-same-origin'); viewerBody.appendChild(iframe);
  } else if (/^video\//i.test(mime)) {
    // You mentioned video isn't viewable from your application:
    const fb = document.createElement('div'); fb.className = 'viewer-fallback';
    fb.innerHTML = `Video preview isn‚Äôt supported here. ${info.inlineOnly ? 'Download is disabled for this item.' : 'If allowed, use the download button to play locally.'}`;
    viewerBody.appendChild(fb);
  } else {
    const fb = document.createElement('div'); fb.className = 'viewer-fallback';
    fb.innerHTML = `Preview not supported for <code>${mime || 'this file type'}</code>.`;
    viewerBody.appendChild(fb);
  }
  openViewer();
});
</script>
</body>
</html>
