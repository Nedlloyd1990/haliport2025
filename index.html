<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üçÅ Haliport ‚Äî Private 1:1 Chat</title>
<style>
  :root{ --bg:#0c0f13; --panel:#141a22; --panel2:#0f141b; --text:#e7edf4; --muted:#9fb0c2; --accent:#57acff; --border:#203041; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  .header{height:64px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--panel)}
  .scroll{flex:1;overflow:auto;padding:18px}
  .row{display:flex;margin:8px 0;position:relative}
  .me{justify-content:flex-end}
  .bubble{max-width:900px;width:fit-content;background:#1d2430;border:1px solid var(--border);padding:12px 14px;border-radius:14px;font-size:1.05rem;line-height:1.5;position:relative}
  .me .bubble{background:#0e2a49;border-color:#0b3a63}
  .meta{color:#9fb0c2;font-size:.85rem;margin-top:6px;text-align:right}
  .composer{position:sticky;bottom:0;display:flex;gap:12px;align-items:flex-end;border-top:1px solid var(--border);padding:14px 16px;background:var(--panel)}
  .textarea{flex:1;min-height:56px;max-height:220px;padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--panel2);color:var(--text);resize:vertical;font-size:1.05rem;line-height:1.5;outline:none}
  .send{background:#1b87f3;border:0;color:#fff;padding:14px 22px;border-radius:14px;cursor:pointer;font-size:1rem}
  .iconbtn{border:1px solid var(--border);background:var(--panel2);color:var(--text);border-radius:12px;cursor:pointer;height:48px;width:48px;display:grid;place-items:center}
  .filecard{display:flex;align-items:center;gap:10px}
  .filethumb{max-width:360px;border-radius:10px;display:block}
  .filename{word-break:break-all}
  .tip{color:#9fb0c2;font-size:.9rem;margin:0 18px 8px}

  /* three-dot */
  .kebab { position:absolute; top:8px; right:8px; background:transparent; border:0; color:#c9d6e2; cursor:pointer; padding:4px; opacity:.7 }
  .kebab:hover { opacity:1 }
  .menu { position:absolute; top:32px; right:8px; background:#111823; border:1px solid var(--border); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; min-width:140px; z-index:5 }
  .menu.open { display:block }
  .menu button { width:100%; text-align:left; padding:10px 12px; background:transparent; border:0; color:#e7edf4; cursor:pointer; font-size:.95rem }
  .menu button:hover { background:#0f141b }
  .tomb { font-style:italic; color:#9fb0c2 }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div><b id="title">Connecting‚Ä¶</b></div>
    <div id="presence" style="color:#9fb0c2">‚Äî</div>
  </div>

  <div class="scroll" id="log"><div style="color:#9fb0c2">Open this URL on two devices to start chatting.</div></div>
  <p class="tip">Press <b>Enter</b> to send ‚Ä¢ <b>Shift+Enter</b> for a new line ‚Ä¢ Click the paperclip to attach files ‚Ä¢ Use the ‚ãØ menu to recall</p>

  <div class="composer">
    <button id="attach" class="iconbtn" title="Attach files" aria-label="Attach files">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21.44 11.05 12 20.5a6 6 0 1 1-8.49-8.49l9.19-9.19a4.2 4.2 0 0 1 5.94 5.94L9.76 18.08a2.4 2.4 0 1 1-3.39-3.4l8.49-8.49"/>
      </svg>
    </button>
    <input id="fileInput" type="file" multiple hidden />
    <textarea id="msg" class="textarea" placeholder="Type a message"></textarea>
    <button id="send" class="send">Send</button>
  </div>
</div>

<script>
const log = document.getElementById('log');
const title = document.getElementById('title');
const presence = document.getElementById('presence');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const attachBtn = document.getElementById('attach');
const fileInput = document.getElementById('fileInput');

let myName = '', myRoom = roomFromPath();

function roomFromPath(){ const p = location.pathname.replace(/^\/+|\/+$/g,''); return p || 'chat'; }
function wsURL(){ const proto = location.protocol === 'https:' ? 'wss://' : 'ws://'; return proto + location.host + location.pathname; }
function humanSize(bytes){ const u=['B','KB','MB','GB']; let v=bytes,i=0; while(v>=1024&&i<u.length-1){v/=1024;i++;} return v.toFixed(v>=10||i===0?0:1)+' '+u[i]; }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function bubbleMenu(id, isMine){
  // Only show Recall for my own items
  return `
    <button class="kebab" data-action="open-menu" data-id="${id}" ${isMine ? '' : 'style="display:none"'} title="More">‚ãØ</button>
    <div class="menu" data-menu-for="${id}">
      <button data-action="recall" data-id="${id}">Recall</button>
    </div>
  `;
}

function writeText(kind, id, text, ts=Date.now()){
  const row = document.createElement('div');
  row.className = 'row ' + (kind==='me' ? 'me' : '');
  row.dataset.id = id;
  row.innerHTML = `
    <div class="bubble">
      ${bubbleMenu(id, kind==='me')}
      <div>${escapeHTML(text)}</div>
      <div class="meta">${new Date(ts).toLocaleString()}</div>
    </div>`;
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

function writeFile(kind, id, file, ts=Date.now()){
  const row = document.createElement('div');
  row.className = 'row ' + (kind==='me' ? 'me' : '');
  row.dataset.id = id;
  const isImg = /^image\//.test(file.mime || '');
  const content = isImg
    ? `<img class="filethumb" src="${file.url}" alt="${escapeHTML(file.name)}" />`
    : `<a class="filename" href="${file.url}" download>${escapeHTML(file.name)}</a> <span style="color:#9fb0c2">(${humanSize(file.size)})</span>`;
  row.innerHTML = `
    <div class="bubble">
      ${bubbleMenu(id, kind==='me')}
      <div class="filecard">${content}</div>
      <div class="meta">${new Date(ts).toLocaleString()}</div>
    </div>`;
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

function removeById(id){
  const el = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`);
  if (!el) return;
  el.querySelector('.bubble').innerHTML = `<div class="tomb">This item was recalled.</div>`;
  // Optional: completely remove after a short delay
  setTimeout(()=> el.remove(), 500);
}

// ---- WebSocket ----
const ws = new WebSocket(wsURL());
ws.onopen = () => { title.textContent = 'Room: ' + myRoom; };
ws.onmessage = (ev) => {
  const data = JSON.parse(ev.data);

  if (data.type === 'room_full') {
    writeText('them', 'Room is full. Create a new path, e.g., /chat-1234');
    msgInput.disabled = true; sendBtn.disabled = true; attachBtn.disabled = true; fileInput.disabled = true;
    presence.textContent = 'Room full';
    return;
  }
  if (data.type === 'welcome') {
    myName = data.yourName;
    presence.textContent = 'In room: ' + (data.users || []).join(', ');
    title.textContent = 'Room: ' + data.room + ' ‚Ä¢ You: ' + myName;
    return;
  }
  if (data.type === 'presence') {
    presence.textContent = 'In room: ' + (data.users || []).join(', ');
    return;
  }
  if (data.type === 'chat') {
    const who = data.from === myName ? 'me' : 'them';
    writeText(who, data.id, data.text, data.ts);
    return;
  }
  if (data.type === 'file') {
    const who = data.from === myName ? 'me' : 'them';
    writeFile(who, data.id, data.file, data.ts);
    return;
  }
  if (data.type === 'recalled') {
    removeById(data.id);
    return;
  }
  if (data.type === 'error') {
    // optional toast
    writeText('them', '‚ö†Ô∏è ' + (data.message || 'Error'));
    return;
  }
};
ws.onclose = () => { presence.textContent = 'Disconnected'; };

// ---- Send text (only render on echo from server so we have the ID) ----
function send() {
  const text = msgInput.value.trim();
  if (!text) return;
  ws.send(JSON.stringify({ type:'chat', text }));
  msgInput.value = '';
}

// ---- Upload files ----
async function uploadFiles(files){
  if (!files || files.length === 0) return;
  const form = new FormData();
  for (const f of files) form.append('file', f);
  try{
    const res = await fetch(`/upload/${encodeURIComponent(myRoom)}`, { method:'POST', body: form });
    if (!res.ok) {
      const json = await res.json().catch(()=>({}));
      throw new Error(json.error || ('Upload failed: ' + res.status));
    }
  }catch(err){
    writeText('them', '‚ö†Ô∏è ' + (err?.message || 'Upload failed'));
  }finally{
    fileInput.value = '';
  }
}

// ---- Recall action via menu ----
function recall(id){
  ws.send(JSON.stringify({ type:'recall', id }));
}

// ---- UI wiring ----
sendBtn.onclick = send;
msgInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
attachBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => uploadFiles(e.target.files));

// Delegate menu interactions
log.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;

  const action = btn.dataset.action;
  const id = btn.dataset.id;

  if (action === 'open-menu') {
    // Close all others
    document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
    const menu = log.querySelector(`.menu[data-menu-for="${CSS.escape(id)}"]`);
    if (menu) menu.classList.add('open');
  }
  if (action === 'recall') {
    // Hide menu & send
    const menu = log.querySelector(`.menu[data-menu-for="${CSS.escape(id)}"]`);
    if (menu) menu.classList.remove('open');
    recall(id);
  }
});

// Close menus when clicking elsewhere
document.addEventListener('click', (e) => {
  const insideMenu = e.target.closest('.menu, .kebab');
  if (!insideMenu) document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
});
</script>
</body>
</html>
