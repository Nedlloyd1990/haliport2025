<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üçÅ Haliport ‚Äî Private 1:1 Chat</title>
<style>
  :root{ --bg:#0b0f14; --panel:#121923; --panel2:#0f151e; --text:#e9f0f7; --muted:#9fb0c2; --accent:#57acff; --border:#1f2b3b; --glass:rgba(255,255,255,.06); --danger:#ff6b6b; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  .header{height:64px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--panel)}
  .scroll{flex:1;overflow:auto;padding:18px}
  .row{display:flex;margin:10px 0;position:relative}
  .me{justify-content:flex-end}
  .bubble{max-width:900px;width:fit-content;background:#172131;border:1px solid var(--border);padding:12px 14px;border-radius:16px;font-size:1.05rem;line-height:1.5;position:relative}
  .me .bubble{background:#0f2744;border-color:#133659}
  .meta{color:#9fb0c2;font-size:.85rem;margin-top:6px;text-align:right}
  .composer{position:sticky;bottom:0;display:flex;gap:12px;align-items:flex-end;border-top:1px solid var(--border);padding:14px 16px;background:var(--panel)}
  .textarea{flex:1;min-height:56px;max-height:220px;padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--panel2);color:var(--text);resize:vertical;font-size:1.05rem;line-height:1.5;outline:none}
  .send{background:#1b87f3;border:0;color:#fff;padding:14px 22px;border-radius:14px;cursor:pointer;font-size:1rem}
  .iconbtn{border:1px solid var(--border);background:var(--panel2);color:var(--text);border-radius:12px;cursor:pointer;height:48px;width:48px;display:grid;place-items:center}
  .filecard{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .filename{word-break:break-all}
  .btn-min{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--glass);cursor:pointer;color:#e7edf4;text-decoration:none}
  .btn-min:hover{background:rgba(255,255,255,.12)}
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; font-size:.78rem; background:#10263e; color:#b8d5ff; border:1px solid #1c3a5e }
  .tomb { font-style:italic; color:#d2dcea }
  .expiry{ color:var(--danger); font-size:.85rem; margin-top:6px }
  .sys{ color:#b7c6d8; font-size:.86rem; margin-top:6px; }
  .row.me .sys{ text-align:right; }
  .status{ color:#9fb0c2; font-size:.92rem; }

  .kebab{ position:absolute; top:6px; right:6px; width:32px; height:32px; display:grid; place-items:center; font-size:18px; background:var(--glass); border:1px solid rgba(255,255,255,.18); border-radius:10px; color:#e7edf4; cursor:pointer; opacity:.7; }
  .bubble:hover .kebab{ opacity:1; }
  .menu{ position:absolute; top:42px; right:6px; background:#0e1622; border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.4); display:none; min-width:170px; z-index:5; }
  .menu.open{ display:block }
  .menu button{ width:100%; text-align:left; padding:10px 12px; background:transparent; border:0; color:#e7edf4; cursor:pointer; font-size:.95rem }

  /* Attachment sheet */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:40; }
  .overlay.open{ display:block; }
  .sheet{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(680px, 94vw);
          background:#0f1622; border:1px solid var(--border); border-radius:20px;
          box-shadow:0 30px 100px rgba(0,0,0,.65); padding:18px; display:none; z-index:41; }
  .sheet.open{ display:block; }
  .sheet h3{ margin:8px 0 14px; font-weight:700; letter-spacing:.2px }
  .choices{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0 6px }
  .choice{ background:linear-gradient(180deg,#0f1927,#0d131d); border:1px solid var(--border);
           border-radius:16px; padding:16px; cursor:pointer; display:flex; flex-direction:column; gap:8px;
           transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
  .choice:hover{ transform:translateY(-2px); box-shadow:0 12px 30px rgba(0,0,0,.4); border-color:#27405e }
  .choice .title{ font-weight:600 }
  .choice .desc{ color:#a9bdd2; font-size:.9rem }
  .divider{ height:1px; background:var(--border); margin:12px 0 }
  .panel{ display:none; gap:10px; align-items:center; flex-wrap:wrap; }
  .panel.active{ display:flex }
  .select{ background:#101725; color:#e7edf4; border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
  .input{ background:#101725; color:#e7edf4; border:1px solid var(--border); border-radius:12px; padding:9px 12px; }
  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px }
  .btn{ border:1px solid var(--border); background:#1b87f3; color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
  .btn.secondary{ background:#0f151e; color:#e7edf4 }
  .ghost{ background:transparent; border:0; color:#a9bdd2; cursor:pointer; }
  .ghost:hover{ color:#d5e6ff; text-decoration:underline }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div><b id="title">Connecting‚Ä¶</b></div>
    <div id="presence" class="status">‚Äî</div>
  </div>

  <div class="scroll" id="log"><div class="status">Open this URL on two devices to start chatting.</div></div>
  <p class="status" style="margin:0 18px 8px">Enter to send ‚Ä¢ Shift+Enter newline ‚Ä¢ Paperclip to attach ‚Ä¢ ‚ãØ to recall ‚Ä¢ üëÅÔ∏è to view inline</p>

  <div class="composer">
    <button id="attach" class="iconbtn" title="Attach files" aria-label="Attach files">üìé</button>
    <input id="fileInput" type="file" multiple hidden />
    <textarea id="msg" class="textarea" placeholder="Type a message"></textarea>
    <button id="send" class="send">Send</button>
  </div>
</div>

<!-- Attachment sheet -->
<div id="overlay" class="overlay"></div>
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="attTitle">
  <h3 id="attTitle">Attachment Options</h3>
  <div id="choices" class="choices">
    <div id="chooseTTL" class="choice"><div class="title">Recall After</div><div class="desc">Auto-recall after a set time. Both sides see a red countdown.</div></div>
    <div id="choosePW" class="choice"><div class="title">Recall with Password</div><div class="desc">Receiver must enter a password to view. One wrong attempt recalls the file.</div></div>
  </div>
  <div class="divider"></div>
  <div id="panelTTL" class="panel" aria-hidden="true">
    <span style="min-width:110px;color:#cfe1f7">Recall after</span>
    <select id="ttlDays" class="select"></select><span>days</span>
    <select id="ttlHours" class="select"></select><span>hours</span>
    <select id="ttlMinutes" class="select"></select><span>minutes</span>
    <select id="ttlSeconds" class="select"></select><span>seconds</span>
  </div>
  <div id="panelPW" class="panel" aria-hidden="true">
    <span style="min-width:110px;color:#cfe1f7">Enter password</span>
    <input id="pwInput" class="input" type="password" placeholder="Enter password" minlength="1" />
  </div>
  <div class="actions">
    <button id="backChoice" class="ghost" style="margin-right:auto; display:none">‚Üê Back</button>
    <button id="sendFiles" class="btn">Send files</button>
    <button id="cancelAttach" class="btn secondary">Cancel</button>
  </div>
</div>

<script>
// Warn if opened as a file (no server => no connection)
if (location.protocol === 'file:') {
  alert('You opened index.html from your filesystem. Please run `node server.js` and open http://localhost:3000/ (or your host URL).');
}

const log = document.getElementById('log');
const title = document.getElementById('title');
const presence = document.getElementById('presence');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const attachBtn = document.getElementById('attach');
const fileInput = document.getElementById('fileInput');

const room = (location.pathname.replace(/^\/+|\/+$/g,'') || 'chat');
let myId = null;
let transport = 'ws'; // 'ws' | 'sse'
let ws = null, sse = null, retries = 0;

// UI helpers
function esc(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]); }
function humanSize(b){ const u=['B','KB','MB','GB']; let v=b,i=0; while(v>=1024&&i<u.length-1){v/=1024;i++;} return v.toFixed(v>=10||i===0?0:1)+' '+u[i]; }
function row(kind,id,inner){ const r=document.createElement('div'); r.className='row ' + (kind==='me'?'me':''); r.dataset.id=id; r.innerHTML=inner; log.appendChild(r); log.scrollTop=log.scrollHeight; return r; }
function bubbleMenu(id, mine){ return `<button class="kebab" data-action="open-menu" data-id="${id}" ${mine?'':'style="display:none"'}>‚ãØ</button><div class="menu" data-menu-for="${id}"><button data-action="recall" data-id="${id}">Recall</button></div>`; }
function writeText(kind, id, text, ts=Date.now()){ row(kind,id,`<div class="bubble">${bubbleMenu(id, kind==='me')}<div>${esc(text)}</div><div class="meta">${new Date(ts).toLocaleString()}</div></div>`); }
function fileControlsHTML(id, file, hasUrl, isProtected){
  const viewBtn = hasUrl ? `<button class="btn-min view-btn" data-id="${id}" data-name="${esc(file.name)}" data-mime="${file.mime || ''}">üëÅÔ∏è View</button>` : '';
  const download = hasUrl && !isProtected ? `<a class="btn-min" href="${file.url}" download>‚¨áÔ∏è Download</a>` : '';
  return `<div class="file-commands" style="display:flex; gap:8px">${viewBtn}${download}</div>`;
}
function writeFile(kind, id, file, ts=Date.now(), expiresAt=null){
  const r = row(kind,id,`<div class="bubble">${bubbleMenu(id, kind==='me')}<div class="filecard"><span class="filename">${esc(file.name)}</span> <span style="color:#9fb0c2">(${humanSize(file.size)})</span>${file.protected?'<span class="badge">üîí Password</span>':''}</div>${fileControlsHTML(id,file,!!file.url,!!file.protected)}${expiresAt?`<div class="expiry" data-expires="${expiresAt}" data-id="${id}">‚è± calculating‚Ä¶</div>`:''}<div class="meta">${new Date(ts).toLocaleString()}</div></div>`);
  if (file.protected && !file.url && kind!=='me'){
    const wrap=document.createElement('div'); wrap.style.marginTop='10px';
    wrap.innerHTML=`<input type="password" class="pwfield" placeholder="Enter password to unlock" style="background:#101725;color:#e7edf4;border:1px solid var(--border);border-radius:10px;padding:10px;width:240px"><button class="btnUnlock btn-min" data-id="${id}">Unlock</button>`;
    r.querySelector('.bubble').appendChild(wrap);
  }
}
function recallForReceiver(id, sysText){
  const r = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`); if (!r) return;
  const b = r.querySelector('.bubble'); if (b) b.innerHTML = `<div class="tomb">This item was recalled by the sender.</div><div class="sys">${sysText||'This item was recalled by the sender.'}</div>`;
}
function markOwnerRecalled(id, sysText){
  const r = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`); if (!r) return;
  r.querySelector('.expiry')?.remove();
  const sys = document.createElement('div'); sys.className='sys'; sys.textContent = sysText || 'You recalled this. The other person can no longer see it.'; r.querySelector('.bubble')?.appendChild(sys);
}
function setOwnerUrl(id){
  const r = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`); if (!r) return;
  const cmds = r.querySelector('.file-commands');
  if (cmds && !cmds.querySelector('.view-btn')) {
    const name = r.querySelector('.filename')?.textContent || 'file';
    const btn = document.createElement('button');
    btn.className='btn-min view-btn'; btn.dataset.id = id; btn.dataset.name = name; btn.textContent='üëÅÔ∏è View';
    cmds.prepend(btn);
  }
}
setInterval(()=>{ const n=Date.now(); document.querySelectorAll('.expiry').forEach(el=>{ const exp=+el.getAttribute('data-expires')||0; const s=Math.max(0,Math.floor((exp-n)/1000)); const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), ss=s%60; el.textContent='‚è± '+(d?d+'d ':'')+(h?h+'h ':'')+(m?m+'m ':'')+ss+'s'; }); },1000);

// Viewer (opens secure URL; simple & reliable across file types)
async function openViewerFor(id){
  let info;
  try{
    const res = await fetch(`/fileurl/${encodeURIComponent(id)}`);
    info = await res.json();
    if (!res.ok || !info?.ok) throw new Error(info?.error || 'Not accessible');
  }catch(err){ writeText('them','_','‚ö†Ô∏è '+(err?.message || 'Preview not accessible')); return; }
  const { url } = info;
  const w = window.open(url, '_blank','noopener'); if (!w) alert('Popup blocked. Please allow popups to preview.');
}

// ---- Transport: WebSocket first, then SSE fallback ----
function wsURL(){ const proto = location.protocol==='https:'?'wss://':'ws://'; return proto + location.host + '/ws?room=' + encodeURIComponent(room); }
function startWS(){
  transport='ws';
  const url = wsURL();
  presence.textContent = `Connecting (WebSocket)‚Ä¶`;
  console.log('[WS] trying', url);
  ws = new WebSocket(url);
  ws.onopen = () => { retries=0; presence.textContent='Connected (WebSocket)'; title.textContent='Room: '+room; console.log('[WS] open'); };
  ws.onerror = (e) => { presence.textContent='WebSocket error'; console.warn('[WS] error', e); };
  ws.onclose = (ev) => {
    console.warn('[WS] closed', ev.code, ev.reason);
    retries++;
    if (retries >= 3) { startSSE(); return; }
    presence.textContent = 'WS closed ‚Äî retrying‚Ä¶';
    setTimeout(startWS, Math.min(3000*retries,10000));
  };
  ws.onmessage = (ev) => handleEvent(JSON.parse(ev.data));
}
function startSSE(){
  transport='sse';
  presence.textContent = 'Connecting (Fallback)‚Ä¶';
  const url = '/sse?room='+encodeURIComponent(room);
  console.log('[SSE] trying', url);
  sse = new EventSource(url);
  sse.onopen  = () => { presence.textContent='Connected (Fallback)'; title.textContent='Room: '+room+' ‚Ä¢ Fallback'; console.log('[SSE] open'); };
  sse.onerror = (e) => { presence.textContent='Reconnecting (Fallback)‚Ä¶'; console.warn('[SSE] error', e); };
  sse.onmessage = (ev) => { try{ handleEvent(JSON.parse(ev.data)); }catch(e){ console.warn('[SSE] bad event', e); } };
}
function sendEvent(obj){
  if (transport==='ws' && ws && ws.readyState===1) {
    ws.send(JSON.stringify(obj));
  } else {
    // Fallback: POST /push
    fetch('/push', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room, ...obj, fromId: myId }) });
  }
}
startWS();

// ---- Event handler ----
function handleEvent(d){
  if (d.type === 'room_full') { presence.textContent='Room is full'; writeText('them','_','Room is full. Use a different path.'); return; }
  if (d.type === 'welcome') { if (d.yourId) myId = d.yourId; presence.textContent = (transport==='ws'?'Connected (WebSocket)':'Connected (Fallback)'); title.textContent = `Room: ${d.room} ${myId?`‚Ä¢ You: ${myId}`:''}`; return; }
  if (d.type === 'presence') { presence.textContent = `Connected ‚Ä¢ users: ${(d.users||[]).length}`; return; }
  if (d.type === 'chat') { writeText(d.fromId===myId?'me':'them', d.id, d.text, d.ts); return; }
  if (d.type === 'file') { writeFile(d.fromId===myId?'me':'them', d.id, d.file, d.ts, d.expiresAt||null); return; }
  if (d.type === 'file_owner') { setOwnerUrl(d.id); return; }
  if (d.type === 'file_unlocked') {
    const r = log.querySelector(`.row[data-id="${CSS.escape(d.id)}"]`);
    r?.querySelector('.pwfield')?.remove(); r?.querySelector('.btnUnlock')?.remove();
    setOwnerUrl(d.id); return;
  }
  if (d.type === 'recalled') { recallForReceiver(d.id, d.sys); return; }
  if (d.type === 'recalled_owner') { markOwnerRecalled(d.id, d.sys); return; }
  if (d.type === 'error') { writeText('them','_','‚ö†Ô∏è '+(d.message||'Error')); return; }
}

// ---- Send / Recall ----
function send(){ const text = msgInput.value.trim(); if(!text) return; sendEvent({ type:'chat', text }); msgInput.value=''; }
function recall(id){ sendEvent({ type:'recall', id }); }
sendBtn.onclick = send;
msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

// ---- Attachment sheet ----
const overlay = document.getElementById('overlay');
const sheet   = document.getElementById('sheet');
const choices = document.getElementById('choices');
const panelTTL= document.getElementById('panelTTL');
const panelPW = document.getElementById('panelPW');
const backBtn = document.getElementById('backChoice');
const sendFilesBtn = document.getElementById('sendFiles');
const cancelAttach = document.getElementById('cancelAttach');
const chooseTTL = document.getElementById('chooseTTL');
const choosePW  = document.getElementById('choosePW');
const selD = document.getElementById('ttlDays');
const selH = document.getElementById('ttlHours');
const selM = document.getElementById('ttlMinutes');
const selS = document.getElementById('ttlSeconds');
const pwInput = document.getElementById('pwInput');

let pendingFiles = null; let mode = null;
function fillSelect(sel, max){ sel.innerHTML=''; for(let i=0;i<=max;i++){ const o=document.createElement('option'); o.value=i; o.textContent=String(i).padStart(2,'0'); sel.appendChild(o);} }
fillSelect(selD, 30); fillSelect(selH, 23); fillSelect(selM, 59); fillSelect(selS, 59);

function openSheet(){ overlay.classList.add('open'); sheet.classList.add('open'); showChoices(); }
function closeSheet(){ overlay.classList.remove('open'); sheet.classList.remove('open'); pendingFiles=null; mode=null; }
function showChoices(){ choices.style.display='grid'; panelTTL.classList.remove('active'); panelPW.classList.remove('active'); backBtn.style.display='none'; }
function showTTL(){ choices.style.display='none'; panelTTL.classList.add('active'); panelPW.classList.remove('active'); backBtn.style.display='inline'; selD.value='0'; selH.value='0'; selM.value='0'; selS.value='0'; mode='ttl'; }
function showPW(){ choices.style.display='none'; panelPW.classList.add('active'); panelTTL.classList.remove('active'); backBtn.style.display='inline'; pwInput.value=''; pwInput.focus(); mode='pw'; }

attachBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=>{ const files = Array.from(e.target.files||[]); if(!files.length) return; pendingFiles = files; openSheet(); });
overlay.addEventListener('click', closeSheet);
cancelAttach.addEventListener('click', closeSheet);
backBtn.addEventListener('click', showChoices);
chooseTTL.addEventListener('click', showTTL);
choosePW.addEventListener('click', showPW);

async function uploadFiles(files, ttlSeconds=0, password=''){
  const form = new FormData();
  for (const f of files) form.append('file', f);
  if (ttlSeconds>0) form.append('ttl', String(ttlSeconds));
  if (password) form.append('pw', password);
  if (myId) form.append('clientId', myId);
  const res = await fetch(`/upload/${encodeURIComponent(room)}`, { method:'POST', body: form });
  if (!res.ok) {
    let j={}; try{ j=await res.json(); }catch{}
    writeText('them','_','‚ö†Ô∏è '+(j.error || ('Upload failed: '+res.status)));
  }
  fileInput.value = '';
}
sendFilesBtn.addEventListener('click', async ()=>{
  if (!pendingFiles) return closeSheet();
  let ttlSeconds=0, password='';
  if (mode==='ttl'){ const d=+selD.value||0, h=+selH.value||0, m=+selM.value||0, s=+selS.value||0; ttlSeconds = d*86400 + h*3600 + m*60 + s; }
  if (mode==='pw'){ password = pwInput.value.trim(); if (!password){ alert('Please enter a password'); return; } }
  await uploadFiles(pendingFiles, ttlSeconds, password);
  closeSheet();
});

// Unlock & menu & view
log.addEventListener('click', async (e) => {
  const ub = e.target.closest('.btnUnlock');
  if (ub){
    const id = ub.dataset.id;
    const r = log.querySelector(`.row[data-id="${CSS.escape(id)}"]`);
    const p = r?.querySelector('.pwfield')?.value || '';
    const res = await fetch(`/unlock/${encodeURIComponent(id)}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: p }) });
    if (!res.ok) { let j={}; try{ j=await res.json(); }catch{}; writeText('them','_','‚ö†Ô∏è '+(j.error || 'Unlock failed')); }
    return;
  }
  const btn = e.target.closest('button'); 
  if (btn && btn.dataset.action==='open-menu'){
    document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open'));
    const menu = log.querySelector(`.menu[data-menu-for="${CSS.escape(btn.dataset.id)}"]`);
    if (menu) menu.classList.add('open');
    return;
  }
  if (btn && btn.dataset.action==='recall'){
    document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open'));
    sendEvent({ type:'recall', id: btn.dataset.id });
    return;
  }
  const vb = e.target.closest('.view-btn'); 
  if (vb){ openViewerFor(vb.dataset.id); return; }
});
document.addEventListener('click', (e) => {
  const inside = e.target.closest('.menu, .kebab, .sheet'); 
  if (!inside) document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open'));
});
</script>
</body>
</html>
