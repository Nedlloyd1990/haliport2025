
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üçÅ Haliport ‚Äî Private 1:1 Chat</title>
<style>
  :root{ --bg:#0c0f13; --panel:#141a22; --panel2:#0f141b; --text:#e7edf4; --muted:#9fb0c2; --accent:#57acff; --border:#203041; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .shell{display:grid;grid-template-columns:320px 1fr;height:100vh}
  .side{background:var(--panel);border-right:1px solid var(--border);padding:16px}
  h1{margin:0 0 8px 0;font-size:20px}
  .card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
  label{display:block;margin:8px 0 4px;color:var(--muted);font-size:.9rem}
  input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f141b;color:#e7edf4;outline:none}
  button{margin-top:10px;padding:10px 12px;border-radius:10px;border:0;background:#1b87f3;color:white;cursor:pointer;width:100%}
  .main{display:flex;flex-direction:column}
  .header{height:64px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
  .scroll{flex:1;overflow:auto;padding:18px}
  .row{display:flex;margin:6px 0}
  .me{justify-content:flex-end}
  .bubble{max-width:70%;background:#1d2430;border:1px solid var(--border);padding:10px 12px;border-radius:12px}
  .me .bubble{background:#0e2a49;border-color:#0b3a63}
  .meta{color:#9fb0c2;font-size:.8rem;margin-top:4px;text-align:right}
  .composer{display:flex;gap:8px;border-top:1px solid var(--border);padding:12px 16px;background:var(--panel)}
  .composer input{flex:1}
  .err{color:#ff6b6b;margin-top:6px;font-size:.9rem}
</style>
</head>
<body>
<div class="shell">
  <aside class="side">
    <h1>üçÅ Haliport</h1>
    <div class="card">
      <label>Room (shareable)</label>
      <input id="room" placeholder="e.g. project-omega" />
      <label>Your name</label>
      <input id="name" placeholder="e.g. Sarah" />
      <button id="join">Join Chat</button>
      <div id="e" class="err" style="display:none"></div>
      <p style="color:#9fb0c2;font-size:.9rem;margin-top:10px">
        Share this page <b>with ?room=ROOM</b> so only people who have the URL can join.
        Each room allows <b>exactly two people</b>.
      </p>
    </div>
    <div class="card">
      <p style="margin:0;color:#9fb0c2">Tip: Create a unique room, like <i>team-47-oct15</i>, then send your partner the link:
      <br><code>https://YOUR_SITE.onrender.com/?room=team-47-oct15</code></p>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div><b id="title">Not joined</b></div>
      <div id="presence" style="color:#9fb0c2">‚Äî</div>
    </div>
    <div class="scroll" id="log"><div style="color:#9fb0c2">Join a room on the left to start chatting.</div></div>
    <div class="composer">
      <input id="msg" placeholder="Type a message" disabled />
      <button id="send" disabled>Send</button>
    </div>
  </main>
</div>

<script>
const qs = new URLSearchParams(location.search);
const roomField = document.getElementById('room');
const nameField = document.getElementById('name');
const e = document.getElementById('e');
const log = document.getElementById('log');
const title = document.getElementById('title');
const presence = document.getElementById('presence');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const joinBtn = document.getElementById('join');

roomField.value = qs.get('room') || '';

let ws, joined = false, myName = '', myRoom = '';

function wsURL(){ return (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host; }

function write(kind, text, ts=Date.now()){
  const row = document.createElement('div');
  row.className = 'row ' + (kind==='me' ? 'me' : '');
  row.innerHTML = `<div class="bubble"><div>${escape(text)}</div><div class="meta">${new Date(ts).toLocaleTimeString()}</div></div>`;
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

function escape(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function setPresence(users){
  presence.textContent = users && users.length ? ('In room: ' + users.join(', ')) : '‚Äî';
}

joinBtn.onclick = () => {
  e.style.display='none';
  const room = roomField.value.trim();
  const name = nameField.value.trim();
  if (!room || !name){ e.textContent='Enter room and name'; e.style.display='block'; return; }

  ws = new WebSocket(wsURL());
  ws.onopen = () => {
    ws.send(JSON.stringify({ type:'join', room, username:name }));
  };
  ws.onmessage = (ev) => {
    const data = JSON.parse(ev.data);
    if (data.type === 'room_full'){
      e.textContent = 'Room already has two people. Pick another room name.';
      e.style.display='block';
      ws.close();
      return;
    }
    if (data.type === 'joined'){
      joined = true; myName = name; myRoom = room;
      title.textContent = 'Room: ' + room;
      msgInput.disabled = false; sendBtn.disabled = false;
      setPresence(data.users);
      const params = new URLSearchParams(location.search);
      params.set('room', room);
      history.replaceState(null,'','?'+params.toString());
    }
    if (data.type === 'presence'){ setPresence(data.users); }
    if (data.type === 'chat'){
      const who = data.from === myName ? 'me' : 'them';
      write(who, data.text, data.ts);
    }
  };
  ws.onclose = () => {
    if (joined){
      write('them','[Disconnected]');
      msgInput.disabled = true; sendBtn.disabled = true;
      presence.textContent = '‚Äî';
    }
  };
};

sendBtn.onclick = () => {
  const text = msgInput.value.trim();
  if (!text) return;
  ws.send(JSON.stringify({ type:'chat', text }));
  msgInput.value = '';
};
</script>
</body>
</html>
